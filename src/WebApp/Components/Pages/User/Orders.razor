@page "/user/orders"
@attribute [Authorize]
@attribute [StreamRendering]
@inject OrderingService OrderingService
@inject ShippingService ShippingService

<PageTitle>Orders | AdventureWorks</PageTitle>
<SectionContent SectionName="page-header-title">Orders</SectionContent>
<OrdersRefreshOnStatusChange />

<div class="orders">
@if (orders is null)
{
    <p>Loading...</p>
}
else if (orders.Length == 0)
{
    <p>You haven't yet placed any orders.</p>
}
else
{
    <ul class="orders-list">
        <li class="orders-header orders-item">
            <div>Number</div>
            <div>Date</div>
            <div class="total-header">Total</div>
            <div>Status</div>
            <div></div>
        </li>
        @foreach (var order in orders)
        {
            <li class="orders-item-container">
                <div class="orders-item" @onclick="() => ToggleShippingDetails(order.OrderNumber)">
                    <div class="order-number">
                        @order.OrderNumber
                    </div>
                    <div class="order-date">
                        @order.Date
                    </div>
                    <div class="order-total">
                       $@order.Total.ToString("0.00")
                    </div>
                    <div class="order-status">
                        <span class="status @order.Status.ToLower()">
                            @order.Status
                        </span>
                    </div>
                    <div class="order-expand">
                        <span class="expand-icon @(expandedOrderId == order.OrderNumber ? "expanded" : "")">
                            &#9660;
                        </span>
                    </div>
                </div>
                @if (expandedOrderId == order.OrderNumber)
                {
                    <div class="shipping-details">
                        @if (loadingShipment)
                        {
                            <p class="shipping-loading">Loading shipping details...</p>
                        }
                        else if (currentShipment is not null)
                        {
                            <div class="shipping-timeline">
                                <h4>Shipping Timeline</h4>
                                <div class="shipping-status">
                                    <span class="shipping-status-badge @GetShippingStatusClass(currentShipment.Status)">
                                        @FormatShippingStatus(currentShipment.Status)
                                    </span>
                                </div>
                                <div class="shipping-address">
                                    <strong>Delivering to:</strong> @currentShipment.CustomerAddress, @currentShipment.CustomerCity, @currentShipment.CustomerCountry
                                </div>

                                @if (currentShipment.StatusHistory.Length > 0)
                                {
                                    <ul class="status-history">
                                        @foreach (var history in currentShipment.StatusHistory.OrderByDescending(h => h.Timestamp))
                                        {
                                            <li class="status-history-item">
                                                <span class="status-dot @GetShippingStatusClass(history.Status)"></span>
                                                <div class="status-content">
                                                    <span class="status-label">@FormatShippingStatus(history.Status)</span>
                                                    <span class="status-time">@history.Timestamp.ToString("MMM dd, yyyy h:mm tt")</span>
                                                    @if (!string.IsNullOrEmpty(history.Notes))
                                                    {
                                                        <span class="status-notes">@history.Notes</span>
                                                    }
                                                </div>
                                            </li>
                                        }
                                    </ul>
                                }

                                @if (currentShipment.Waypoints.Length > 0)
                                {
                                    <div class="waypoints-section">
                                        <h5>Route Progress</h5>
                                        <div class="waypoints-list">
                                            @foreach (var waypoint in currentShipment.Waypoints.OrderBy(w => w.Sequence))
                                            {
                                                <div class="waypoint-item @(waypoint.DepartedAt.HasValue ? "completed" : waypoint.ArrivedAt.HasValue ? "current" : "pending")">
                                                    <span class="waypoint-icon">
                                                        @if (waypoint.DepartedAt.HasValue)
                                                        {
                                                            <text>&#10003;</text>
                                                        }
                                                        else if (waypoint.ArrivedAt.HasValue)
                                                        {
                                                            <text>&#9679;</text>
                                                        }
                                                        else
                                                        {
                                                            <text>&#9675;</text>
                                                        }
                                                    </span>
                                                    <span class="waypoint-name">
                                                        @(waypoint.WarehouseName ?? $"Warehouse #{waypoint.WarehouseId}")
                                                    </span>
                                                </div>
                                            }
                                            <div class="waypoint-item @(currentShipment.Status == "Delivered" ? "completed" : "pending")">
                                                <span class="waypoint-icon">
                                                    @if (currentShipment.Status == "Delivered")
                                                    {
                                                        <text>&#10003;</text>
                                                    }
                                                    else
                                                    {
                                                        <text>&#9675;</text>
                                                    }
                                                </span>
                                                <span class="waypoint-name">Your Address</span>
                                            </div>
                                        </div>
                                    </div>
                                }

                                @if (currentShipment.CompletedAt.HasValue)
                                {
                                    <p class="delivery-completed">
                                        Delivered on @currentShipment.CompletedAt.Value.ToString("MMMM dd, yyyy at h:mm tt")
                                    </p>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="no-shipping">Shipping information not yet available.</p>
                        }
                    </div>
                }
            </li>
        }
    </ul>
}
</div>

<style>
    .orders-item-container {
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }

    .orders-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .orders-item:hover {
        background-color: var(--hover-bg, #f5f5f5);
    }

    .order-expand {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .expand-icon {
        transition: transform 0.2s;
        font-size: 0.8em;
        color: #666;
    }

    .expand-icon.expanded {
        transform: rotate(180deg);
    }

    .shipping-details {
        padding: 1rem 1.5rem;
        background-color: var(--details-bg, #fafafa);
        border-top: 1px solid var(--border-color, #e0e0e0);
    }

    .shipping-timeline h4 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
        color: #333;
    }

    .shipping-status {
        margin-bottom: 1rem;
    }

    .shipping-status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .shipping-status-badge.created { background-color: #e0e0e0; color: #333; }
    .shipping-status-badge.shipperassigned { background-color: #bbdefb; color: #1565c0; }
    .shipping-status-badge.pickedupfromwarehouse { background-color: #c8e6c9; color: #2e7d32; }
    .shipping-status-badge.intransittowarehouse { background-color: #fff9c4; color: #f57f17; }
    .shipping-status-badge.arrivedatwarehouse { background-color: #b3e5fc; color: #0277bd; }
    .shipping-status-badge.deliveringtocustomer { background-color: #ffe0b2; color: #ef6c00; }
    .shipping-status-badge.delivered { background-color: #a5d6a7; color: #1b5e20; }
    .shipping-status-badge.cancelled { background-color: #ffcdd2; color: #c62828; }
    .shipping-status-badge.returnedtowarehouse { background-color: #e1bee7; color: #7b1fa2; }

    .shipping-address {
        margin-bottom: 1rem;
        color: #666;
    }

    .status-history {
        list-style: none;
        padding: 0;
        margin: 1rem 0;
    }

    .status-history-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.5rem 0;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 0.25rem;
    }

    .status-dot.created { background-color: #9e9e9e; }
    .status-dot.shipperassigned { background-color: #1976d2; }
    .status-dot.pickedupfromwarehouse { background-color: #43a047; }
    .status-dot.intransittowarehouse { background-color: #fbc02d; }
    .status-dot.arrivedatwarehouse { background-color: #039be5; }
    .status-dot.deliveringtocustomer { background-color: #fb8c00; }
    .status-dot.delivered { background-color: #2e7d32; }
    .status-dot.cancelled { background-color: #e53935; }
    .status-dot.returnedtowarehouse { background-color: #8e24aa; }

    .status-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .status-label {
        font-weight: 500;
    }

    .status-time {
        font-size: 0.85rem;
        color: #666;
    }

    .status-notes {
        font-size: 0.85rem;
        color: #888;
        font-style: italic;
    }

    .waypoints-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color, #e0e0e0);
    }

    .waypoints-section h5 {
        margin: 0 0 0.75rem;
        font-size: 1rem;
        color: #333;
    }

    .waypoints-list {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .waypoint-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
    }

    .waypoint-item.completed { color: #2e7d32; }
    .waypoint-item.current { color: #1976d2; font-weight: 500; }
    .waypoint-item.pending { color: #9e9e9e; }

    .waypoint-item::after {
        content: '\2192';
        margin-left: 0.5rem;
        color: #9e9e9e;
    }

    .waypoint-item:last-child::after {
        display: none;
    }

    .delivery-completed {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #e8f5e9;
        border-radius: 0.5rem;
        color: #1b5e20;
        font-weight: 500;
    }

    .shipping-loading, .no-shipping {
        color: #666;
        font-style: italic;
    }
</style>

@code {
    private OrderRecord[]? orders;
    private int? expandedOrderId;
    private ShipmentDto? currentShipment;
    private bool loadingShipment;

    protected override async Task OnInitializedAsync()
    {
        orders = await OrderingService.GetOrders();
    }

    private async Task ToggleShippingDetails(int orderNumber)
    {
        if (expandedOrderId == orderNumber)
        {
            expandedOrderId = null;
            currentShipment = null;
        }
        else
        {
            expandedOrderId = orderNumber;
            loadingShipment = true;
            StateHasChanged();

            try
            {
                currentShipment = await ShippingService.GetShipmentByOrderIdAsync(orderNumber);
            }
            catch
            {
                currentShipment = null;
            }
            finally
            {
                loadingShipment = false;
            }
        }
    }

    private string GetShippingStatusClass(string status)
    {
        return status.ToLower().Replace(" ", "");
    }

    private string FormatShippingStatus(string status)
    {
        return status switch
        {
            "Created" => "Order Created",
            "ShipperAssigned" => "Shipper Assigned",
            "PickedUpFromWarehouse" => "Picked Up",
            "InTransitToWarehouse" => "In Transit",
            "ArrivedAtWarehouse" => "At Warehouse",
            "DeliveringToCustomer" => "Out for Delivery",
            "Delivered" => "Delivered",
            "Cancelled" => "Cancelled",
            "ReturnedToWarehouse" => "Returned",
            _ => status
        };
    }
}
