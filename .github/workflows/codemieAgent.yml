name: Call CodeMie Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: Prompt to send to CodeMie Agent
        required: true
        type: string

jobs:
  call:
    runs-on: ubuntu-latest
    env:
      ASSISTANT_ID: ${{ secrets.ASSISTANT_ID }}
      PROMPT: ${{ inputs.prompt }}
    steps:
      - name: Get Access Token
        id: auth
        env:
          CODEMIE_CLIENT_ID: ${{ secrets.CODEMIE_CLIENT_ID }}
          CODEMIE_CLIENT_SECRET: ${{ secrets.CODEMIE_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          ACCESS_TOKEN=$(curl -s -X POST 'https://keycloak.eks-core.aws.main.edp.projects.epam.com/auth/realms/codemie-prod/protocol/openid-connect/token' \
                          -H 'Content-Type: application/x-www-form-urlencoded' \
                          -d 'grant_type=password' \
                          -d 'client_id=codemie-sdk' \
                          -d "username=${CODEMIE_CLIENT_ID}" \
                          -d "password=${CODEMIE_CLIENT_SECRET}" | jq -r '.access_token')

          if [[ -z "${ACCESS_TOKEN}" || "${ACCESS_TOKEN}" == "null" ]]; then
            echo "Failed to obtain access token" >&2
            exit 1
          fi

          echo "access_token=${ACCESS_TOKEN}" >> $GITHUB_OUTPUT
          echo "Access token obtained successfully"

      - name: Call CodeMie Agent
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        run: |
          set -euo pipefail

          RESPONSE=$(curl -s -X POST "https://codemie.lab.epam.com/code-assistant-api/v1/assistants/${ASSISTANT_ID}/model" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -d "{\"text\": \"${PROMPT}\"}")
          echo "$RESPONSE"
          GENERATED=$(echo "$RESPONSE" | jq -r '.generated')
          RESULT=$(echo "$GENERATED" | grep -oP 'result: \K\w+' | head -1)
          DETAIL=$(echo "$GENERATED" | sed -n '/detail:/,$p' | sed '1d')
          
          echo "CodeMie Agent Response:"
          echo "$DETAIL"
          
          if [[ "$RESULT" != "true" ]]; then
            echo "Pipeline failed: result is false" >&2
            exit 1
          fi

      - name: Validate Workflow
        run: |
          RANDOM_ID=$(uuidgen)
          echo "Workflow validation ID: $RANDOM_ID"

